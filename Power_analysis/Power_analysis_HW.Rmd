---
title: "Power_analysis_HW"
author: "Dmitrii Belousov"
date: "2025-01-15"
output: html_document
number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(TrialSize)
library(epiR)
```

# Задача 1.

Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении
хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное
увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на
1 визите.
Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3
месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей
эффективности – 2 %.

## Решение.

Статистическая гипотеза не меньшей эффективности в исследовании была сформулирована следующим
образом:

$H_0:\mu_T - \mu_R \leqslant \delta$ <br>
$H_A:\mu_T - \mu_R > \delta$

Где $\mu_T$ – абсолютный прирост индекса за 3 месяца в среднем для препарата Т, 
$\mu_R$ – абсолютный прирост индекса за 3 месяца в среднем для препарата R, 
δ – граница не меньшей эффективности (-2%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет равномерным в соотношении 1:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;
4. На основании литературных данных мы ожидаем величину эффекта в группе препарата T $\geqslant$ 5.2 ($\mu_T$) и в группе препарата R $\approx 7.2$ $(\mu_R)$;
5. Граница не меньшей эффективности препарата по сравнению с активным контролем равна -2%;

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build 394) c использованием
языка R (версия 4.4.2) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия `r packageVersion("TrialSize")`).

Результаты расчёта представлены далее.

```{r}
TwoSampleMean.NIS(
  alpha = 0.025,
  beta = 0.2,
  sigma = 3.1,
  k = 1,
  delta = 0,
  margin = -2
)
```
Таким образом, в каждую группу необходимо включить не менее 38 обследуемых, всего – 76
пациентов.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в каждую группу
необходимо набрать не менее `r ceiling(1.2 * 38)` человек. В скрининг (с учётом 10% выбывания) необходимо
включить не менее `r ceiling(1.2 * 38 * 1.1)` обследуемых в каждую группу.

# Задача 2.

Исследование превосходства препарата T над референтным лечением R в лечении
рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к
визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно
литературным данным, на фоне применения препарата R доля пациентов без новых очагов
составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на
15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор
просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

## Решение.

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

$H_0:P_T - P_R \leqslant \delta$ <br>
$H_A:P_T - P_R > \delta$

Где $P_T$ – доля пациентов без новых очагов на 3 визит (12 мес.) для препарата Т, 
$P_R$ – доля пациентов без новых очагов на 3 визит (12 мес.) для препарата R, 
δ – граница превосходства (1%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет неравномерным в соотношении 2:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;
4. На основании литературных данных мы ожидаем  доля пациентов без новых очагов на 3 визит (12 мес.) в группе препарата T $\approx 81\%$ ($P_T$) и в группе препарата R $\approx 66\%$ $(P_R)$;
5. Граница не меньшей эффективности препарата по сравнению с активным контролем равна 1%;

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build 394) c использованием
языка R (версия 4.4.2) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия `r packageVersion("TrialSize")`).

Результаты расчёта представлены далее.

```{r}
N <- TwoSampleProportion.NIS(
  alpha = 0.025,
  beta = 0.2,
  p1 = 0.81,
  p2 = 0.66,
  k = 2,
  delta = 0.15,
  margin = 0.01
)
N <- ceiling(N)
print(N)
```
Таким образом, в тестовую группу необходимо включить `r N` обследуемых, в контрольную группу `r ceiling(0.5 * N)`, всего – `r N + ceiling(0.5 * N)` пациентов.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в тестовую группу необходимо включить `r ceiling(1.2 * N)` обследуемых, в контрольную группу `r ceiling(1.2 * ceiling(0.5 * N))`, всего – `r ceiling(1.2 * N) + ceiling(1.2 * ceiling(0.5 * N))` пациентов. В скрининг (с учётом 10% выбывания) в тестовую группу необходимо включить `r ceiling(1.2 * 1.1 * N)` обследуемых, в контрольную группу `r ceiling(1.2 * 1.1 * ceiling(0.5 * N))`, всего – `r ceiling(1.2 * 1.1 * N) + ceiling(1.2 * 1.1 * ceiling(0.5 * N))` пациентов.

# Задача 3.

Исследование превосходства нового препарата А над препаратом Б в профилактике
интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из
данных литературы известно, что средний объём кровопотери при применении препарата Б
составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём
кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается
установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы
препарат А получили 75% пациентов, включённых в исследование.

## Решение.

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

$H_0:\mu_А - \mu_Б \geqslant \delta$ <br>
$H_A:\mu_А - \mu_Б < \delta$

Где $\mu_А$ – средний объем кровопотери (мл.) в группе препарата А, 
$\mu_Б$ – средний объем кровопотери (мл.) в группе препарата Б, 
δ – граница превосходства (-50 мл).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет неравномерным в соотношении 3:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;
4. На основании литературных данных мы ожидаем средний объем кровопотери (мл.) в группе препарата А $\approx 256$ml ($\mu_А$) и в группе препарата R $\approx 306$ml $(\mu_Б)$;
5. Граница не меньшей эффективности препарата по сравнению с активным контролем равна -50ml.

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build 394) c использованием
языка R (версия 4.4.2) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия `r packageVersion("TrialSize")`).

Результаты расчёта представлены далее.

```{r}
delta <- - 306 * 0.2 

N <- TwoSampleMean.NIS(
  alpha = 0.025,
  beta = 0.2,
  sigma = 52,
  k = 3,
  delta = -50,
  margin = delta
)

N <- ceiling(N)
print(N)
```
Таким образом, в тестовую группу необходимо включить `r N` обследуемых, в контрольную группу `r ceiling(N / 3)`, всего – `r N + ceiling(N / 3)` пациентов.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в тестовую группу необходимо включить `r ceiling(1.2 * N)` обследуемых, в контрольную группу `r ceiling(1.2 * ceiling(N / 3))`, всего – `r ceiling(1.2 * N) + ceiling(1.2 * ceiling(N / 3))` пациентов. В скрининг (с учётом 10% выбывания) в тестовую группу необходимо включить `r ceiling(1.2 * 1.1 * N)` обследуемых, в контрольную группу `r ceiling(1.2 * 1.1 * ceiling(N / 3))`, всего – `r ceiling(1.2 * 1.1 * N) + ceiling(1.2 * 1.1 * ceiling(N / 3))` пациентов.

# Задача 4.

Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев
наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как
ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать
снижение доли пациентов с рецидивом более, чем на 5%.
При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и
он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на
проведение исследования.

## Решение.

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

$H_0:P_Y - P_X \geqslant \delta$ <br>
$H_A:P_Y - P_X < \delta$

Где $P_X$ – частота рецидивов псориатического артрита за 6 месяцев в группе препарата X, 
$P_Y$ – частота рецидивов псориатического артрита за 6 месяцев в группе препарата Y, 
δ – граница превосходства (-5%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет определена на основании фиксированных величин ошибок I и II рода при условии, что препарат X  могут получить не более 250 пациентов, препарат сравнения X должно получить максимально возможное количество пациентов;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;
4. На основании литературных данных мы ожидаем частота рецидивов псориатического артрита за 6 месяцев в группе препарата X $\approx 32\%$ ($P_X$) и в группе препарата Y $\approx 17\%$ $(P_Y)$;
5. Граница превосходства препарата по сравнению с активным контролем равна -5%;

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build 394) c использованием
языка R (версия 4.4.2) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия `r packageVersion("TrialSize")`).

Результаты расчёта представлены далее.

```{r}

k_vec <- seq(0.1, 5, 0.1)

get_n <- function(k) {
  N <- TwoSampleProportion.NIS(
    alpha = 0.025,
    beta = 0.2,
    p1 = 0.32,
    p2 = 0.17,
    k = k,
    delta = -0.15,
    margin = -0.05
  )
  
  N <- ceiling(N)
  N_ref <- ceiling(N * 1.2 / k)
  
  return(N_ref)
}

n_vec <- sapply(X = k_vec, FUN = get_n)
n_max <- max(n_vec[n_vec <= 250])
k_max <- k_vec[n_vec == n_max]

print(ceiling(n_max * k_max / 1.2))
```
Таким образом, в тестовую группу необходимо включить `r ceiling(n_max * k_max / 1.2)` обследуемых, в контрольную группу `r ceiling(n_max / 1.2)`, всего – `r ceiling(n_max * k_max / 1.2) + ceiling(n_max / 1.2)` пациентов.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в тестовую группу необходимо включить `r ceiling(n_max * k_max)` обследуемых, в контрольную группу `r n_max`, всего – `r ceiling(n_max * k_max) + n_max` пациентов. В скрининг (с учётом 10% выбывания) в тестовую группу необходимо включить `r ceiling(n_max * k_max * 1.1)` обследуемых, в контрольную группу `r ceiling(n_max * 1.1)`, всего – `r ceiling(n_max * k_max * 1.1) + ceiling(n_max * 1.1)` пациентов.








