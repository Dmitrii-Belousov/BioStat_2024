---
title: "HW_1"
author: "Dmitrii Belousov"
date: "2024-11-17"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(exact2x2)
```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез.
В качестве задания протестируйте их, используя соответствующие статистические критерии.
Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы.
При необходимости аргументируйте выбор одностороннего теста.
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.

-   Решение необходимо загружать в формате Rmd (воспроизводимый код). \*\* Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr \*\*\* Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).

# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size \<- 100). Как изменится стратегия при малых выборках (sample_size \<- 30) ?

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rbinom(sample_size, size = 1, prob = 0.5)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- rbinom(sample_size, size = 1, prob = ifelse(activity == 1, 0.5, 0.6))

table(activity, cardio)
    
```

$Н_0$: $p_{ССЗ\;в\;гр.\;акт.} = p_{ССЗ\;в\;гр.\;неакт.}$, $Н_{альт}$: $p_{ССЗ\;в\;гр.\;акт.} \neq p_{ССЗ\;в\;гр.\;неакт.}$.
Зададим уровень значимости $\alpha = 0.05$.
Большая выборка позволяет использовать ассимптотические тесты, поэтому для тестирования гипотезы в этой выборке мы используем тест хи-квадрат.
Критическое значение статистики для односторонней гипотезы:

```{r}
alpha <- 0.05
chi_critical <- qchisq(1 - alpha, df = 1)
chi_critical
```

```{r}
chisq.test(table(activity, cardio))
```
Результат свидетельствует о статистически и практически не значимой ассоциации.


```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rbinom(sample_size, size = 1, prob = 0.5)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- rbinom(sample_size, size = 1, prob = ifelse(activity == 1, 0.5, 0.6))

table(activity, cardio)
    
```
```{r}
fisher.test(table(activity, cardio))
```

```{r}
chisq.test(table(activity, cardio), simulate.p.value = T, B = 1000)
```

Для малой выборки лучше использовать точный тест Фишера или тест хи-квадрат 
Пирсона с симулированными р-значениями методом Монте-Карло. Тем не менее, 
результаты все равно не значимы.


# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(n = sample_size, mean = 130, sd = 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(n = sample_size, mean = 135, sd = 10)  # контрольная группа

```

$Н_0$: $\mu_1 = \mu_2$, $Н_{альт}$: $\mu_1 \neq \mu_2$.
Зададим уровень значимости $\alpha = 0.05$.
Используем для проверки этой гипотезы Т-тест Стьюдента.

```{r}
alpha = 0.05
df = sample_size * 2 - 2
upper = qt(p = 1 - alpha / 2, df = df)
lower = qt(p = alpha / 2, df = df)

sprintf("Критические значения статистики: [%.2f, %.2f]", lower, upper)
```


## Решение

```{r}

t.test(group1, group2, var.equal = T)

```
Статистически, различия значимы, р-значение меньше выбранного порога значимости. Клинически, я предполагаю, что тоже, так как лечение позволило уменьшить давление до показателей близких к верхней границе нормы. Хочу отметить, что результат теста мог быть разным в зависимости от того, какую дисперсию я бы выбрал для симуляции выборки.


# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(n = sample_size, size = 100, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(n = sample_size, size = 100, prob = 0.6)  


```

$Н_0$: $p(X_{before} > X_{after}) = p(X_{after} > X_{before})$, $Н_{альт}$: $p(X_{before} > X_{after}) \neq p(X_{after} > X_{before})$.
Зададим уровень значимости $\alpha = 0.05$.
Используем для проверки этой гипотезы тест Вилкоксона для зависимых выборок.

```{r}
alpha = 0.05
upper = qsignrank(1 - alpha/2, n = sample_size, lower.tail = F)
lower = qsignrank(alpha/2, n = sample_size, lower.tail = F)

sprintf("Критические значения статистики: [%.2f, %.2f]", lower, upper)
```


## Решение

```{r}
wilcox.test(before, after, exact = FALSE, paired = T)
```

Мы получили статистически значимые различия, однако клиническая значимость результата под вопросом, потому что шкала вымышленная.

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- rbinom(sample_size, size = 1, prob = 0.5)

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- rbinom(sample_size, size = 1, prob = ifelse(treatment == 1, 0.7, 0.65))

table(treatment, activity)
```

$Н_0$: $p_{норм.физ.акт\;в\;гр.\;плацебо} = p_{норм.физ.акт\;в\;гр.\;лечения}$, 
$Н_{альт}$: $p_{норм.физ.акт\;в\;гр.\;плацебо} \neq p_{норм.физ.акт\;в\;гр.\;лечения}$.
Зададим уровень значимости $\alpha = 0.05$.
Большая выборка позволяет использовать ассимптотические тесты, поэтому для тестирования гипотезы в этой выборке мы используем тест хи-квадрат.
Критическое значение статистики:

```{r}
alpha <- 0.05
chi_critical <- qchisq(1 - alpha, df = 1)
chi_critical
```

## Решение

```{r}
chisq.test(table(treatment, activity))
```
Результат свидетельствует о статистически и практически не значимой ассоциации.


# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- rbinom(sample_size, size = 1, prob = 0.5)

# Генерация данных после медитации (бинарная переменная). 
# После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- rbinom(sample_size, size = 1, prob = ifelse(before == 1, 0.2, 0.4))
table(before, after)
```

$Н_0$: $p_{before} = p_{after}$, $Н_{альт}$: $p_{before} \neq p_{after}$.
Зададим уровень значимости $\alpha = 0.05$.
Большая выборка позволяет использовать ассимптотические тесты, наблюдения связаны, поэтому используем тест МакНемара.
Критическое значение статистики для односторонней гипотезы:

```{r}
alpha <- 0.05
chi_critical <- qchisq(1 - alpha, df = 1)
chi_critical
```


## Решение

```{r}
mcnemar.exact(table(before, after))
```

Результат статистически и практически значим. Точный тест был использован так как он дает оценки доверительных интервалов.

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rbinom(n = sample_size, size = 100, prob = 0.55)

# Генерация данных для группы со стандартным лечением
group2 <- rbinom(n = sample_size, size = 100, prob = 0.68)

```


$Н_0$: $p(X_{experimental} > X_{control}) = p(X_{experimental} > X_{control})$, $Н_{альт}$: $p(X_{experimental} > X_{control}) \neq p(X_{experimental} > X_{control})$.
Зададим уровень значимости $\alpha = 0.05$.
Используем для проверки этой гипотезы тест Манна-Уитни-Вилкоксона.

```{r}
alpha = 0.05
upper = qwilcox(1 - alpha/2, n = sample_size, m = sample_size, lower.tail = F)
lower = qwilcox(alpha/2, n = sample_size, m = sample_size, lower.tail = F)

sprintf("Критические значения статистики: [%.2f, %.2f]", lower, upper)
```

Применим асимптотический тест Манна-Уитни:

## Решение

```{r}
wilcox.test(group1,group2,conf.int=TRUE, exact = F)
```
Результат статистически значим, практически, вероятно, тоже.

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных

```{r, warning=F}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

sigma_X <- 2
sigma_Y <- 3

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(sigma_X ** 2, -0.5 * sigma_X * sigma_Y, -0.5 * sigma_X * sigma_Y, sigma_Y ** 2), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```

$H_0$: $\rho = 0$, $H_{альт}$: $\rho \neq 0$. 
Для проверки гипотезы будем использовать критерий корреляции Пирсона. Рассчитаем критические значения t-статистики:

```{r}
alpha <- 0.05
upper <- qt(p = 1 - alpha/2, df = sample_size - 2)
lower <- qt(p =  alpha/2, df = sample_size - 2)
sprintf("Критические значения статистики: [%.2f, %.2f]", lower, upper)
```


## Решение (дополните решение визуализацией)

```{r}
library(ggpubr)
res <- psych::corr.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
print(res, short=FALSE)

t_obs <- (res$r * sqrt(sample_size)) / sqrt(1 - res$r ** 2)

sprintf("Наблюдаемое значение t-тсатистики: %.2f", t_obs)

df %>% 
  ggplot(aes(y = HoursOfSleep, x = StressLevel)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(p.accuracy = 0.001, r.accuracy = 0.01) +
  theme_bw()

```

Результат статистически практически значим.
